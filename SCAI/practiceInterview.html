<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Meeting</title>
  
</head>
<style>
    body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f3f4f6;
}

.meeting-container {
    display: flex;
    height: 100vh;
}

.user-panel, .virtual-character-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
    border: 2px solid #e0e0e0;
}

#userVideo {
    width: 40%;
    max-height: 40%;
    border-radius: 10px;
}

.controls {
    margin-top: 20px;
    display: inline-block;
}

.controls button {
    display: inline-block;
    margin: 5px;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    background-color: #2d2d2d;
    color: #ffffff;
    cursor: pointer;
    transition: background-color 0.3s;
}

.controls button:hover {
    background-color: #555555;
}
.system-message-container {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
}

#systemMessage {
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 14px;
    flex-grow: 1; /* Makes the textarea take all available space */
    margin-right: 10px; /* Spacing between textarea and button */
    outline: none; /* Removes the default focus outline */
    transition: border-color 0.3s ease; /* Smooth transition for focus effect */
}

#systemMessage:focus {
    border-color: #007BFF; /* Changes the border color when textarea is focused */
}
.hidden {
    display: none;
  }
#updateSystemMessage {
    padding: 10px 15px;
    background-color: #007BFF;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease; /* Smooth transition for hover effect */
}

#updateSystemMessage:hover {
    background-color: #0056b3; /* Slightly darker shade for hover */
}

.key-input-container {
    width: 300px;
    margin: 50px auto;
    padding: 20px;
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .form-group {
    margin-bottom: 10px;
  }
  label {
    display: block;
    margin-bottom: 5px;
  }
  input[type="text"] {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  input[type="password"] {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  button {
    width: 100%;
    padding: 10px;
    border: none;
    background: #007bff;
    color: white;
    border-radius: 4px;
    cursor: pointer;
  }
  button:hover {
    background: #0056b3;
  }

  .checkbox-group {
    margin-bottom: 15px;
  }
  .checkbox-label {
    display: flex;
    align-items: center;
  }
  .checkbox-label input[type="checkbox"] {
    margin-right: 5px;
  }

  #transcription {
  background-color: #f5f5f5; /* light grey background for the whole chat */
  padding: 10px;
  border-radius: 5px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

.message {
  padding: 10px;
  margin: 5px;
  border-radius: 8px;
  display: inline-block;
  max-width: 80%;
}

.interviewee {
  background-color: #c8e6c9; /* pastel green for interviewee */
  align-self: flex-end;
  margin-left: auto;
}

.transcription {
  background-color: #bbdefb; /* pastel blue for AI */
  align-self: flex-start;
  margin-right: auto;
}

/* Scroll to bottom automatically */
.autoscroll {
  scroll-behavior: smooth;
}
#download-btn {
  padding: 10px 20px;
  background-color: #e0e0e0; /* Light grey color */
  border: none;
  border-radius: 5px;
  cursor: pointer;
  margin: 10px 0;
}

#download-btn:hover {
  background-color: #d5d5d5; /* Slightly darker grey on hover */
}
</style>

<body>
    
    <div class="meeting-container">
        <div class="key-input-container">
            <div class="form-group">
              <label for="openai-key">AI API Key:</label>
              <input type="password" id="openai-key" placeholder="Enter your OpenAI key">
            </div>
            <!-- <div class="checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" id="ai-audio-checkbox">
                  Use AI Enhanced Audio
                </label>
              </div>
              <div class="form-group hidden" id="elevenlabs-key-group">
                <label for="elevenlabs-key">Enhanced Audio API Key:</label>
                <input type="password" id="elevenlabs-key" placeholder="Enter your ElevenLabs key">
              </div> -->

            <button id="submit-keys">Submit Keys</button>
            <br>
            <div class="form-group" style="padding-top: 10px;">
              <label for="systemMessage">Whom are you interviewing:</label>
              <textarea id="systemMessage" placeholder="Enter the role of your interviewee"></textarea>
            </div>
            
            <button id="updateSystemMessage">Update System Message</button>
          </div>

          
        <div class="virtual-character-panel">
            
            <video id="background-video" width="100%" height="320" loop>
                <source src="images/womentalking.mp4" type="video/mp4">
                Your browser does not support the video tag.
              </video>
            <video id="userVideo" autoplay style="width: 100%; padding-top: 10%;"></video>
            <div class="controls">
                <!-- <button id="toggleCamera">Close Camera</button> -->
                <button id="startRecord">Start Recording</button>
                <button id="stopRecord" disabled>Stop Recording</button>
              
            </div>
            <!-- <div style="width:480px"><iframe allow="fullscreen" frameBorder="0" height="270" src="https://giphy.com/embed/or5Fd8WKuuNCjfXNjy/video" width="480"></iframe></div> -->
        </div>
        <div class="user-panel">
            <button id="download-btn">Download Transcription</button>
            <div id="transcription" style="font-size: large; overflow-y: scroll; height: 100%;"></div>
        </div>
       
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>


// you are an instructor at UCSC teaching research methods class. I am interviewing to learn more about how we can use games in classrooms. 


// document.getElementById('ai-audio-checkbox').addEventListener('change', function() {
//     var elevenLabsGroup = document.getElementById('elevenlabs-key-group');
//     if (this.checked) {
//       elevenLabsGroup.classList.remove('hidden');
//     } else {
//       elevenLabsGroup.classList.add('hidden');
//     }
//   });


  document.getElementById('submit-keys').onclick = function() {
    var openaiKey = document.getElementById('openai-key').value;
    localStorage.setItem('openaiKey', openaiKey);
    // var elevenLabsKey = document.getElementById('elevenlabs-key').value;
    // var useAIAudio = document.getElementById('ai-audio-checkbox').checked;

    // Make sure to check if AI audio checkbox is checked before saving ElevenLabs key
    // if (openaiKey && (useAIAudio ? elevenLabsKey : true)) {
    //   localStorage.setItem('openaiKey', openaiKey);
    //   if (useAIAudio) {
    //     localStorage.setItem('elevenLabsKey', elevenLabsKey);
    //   }
    //   localStorage.setItem('useAIAudio', useAIAudio);
    //   alert('API Keys and preferences saved!');
    // } else {
    //   alert('Please enter the OpenAI key and ElevenLabs key if AI Enhanced Audio is selected.');
    // }
  };


const toggleCameraButton = document.getElementById('toggleCamera');
navigator.mediaDevices.getUserMedia({ video: true})
    .then(localStream => {
        stream = localStream;
        userVideo.srcObject = localStream;
    })
    .catch(error => {
        console.error('Error accessing the camera or microphone:', error);
    });

// toggleCameraButton.addEventListener('click', () => {
//     if (!stream) return;

//     isCameraOn = !isCameraOn;
//     stream.getVideoTracks()[0].enabled = isCameraOn;

//     toggleCameraButton.textContent = isCameraOn ? 'Close Camera' : 'Open Camera';
// });

        
let audioChunks = [];
let chatHistory = [{
    role: 'system',
    content: 'You are a helpful teacher assisting with interview preparations.'}
];

$('#updateSystemMessage').on('click', function() {
    const systemContent = $('#systemMessage').val().trim();
    var prompt = 'I am a student and a researcher practicing my ability to conduct UX research interviews skills. I will need you to respond to various questions I ask. Respond very natuarlly to mimic a scenario in a real life interview, feel free to have filler words. You are being interviewed and make sure you act like the persona you are assigned, you are free to make up responses.'
    if (systemContent) {
        chatHistory = [
            {role: 'system', content: prompt + ' ' + systemContent}
        ];
        console.log('updated system role')
    } else {
        console.log('Failed to update system role');
    }
});

navigator.mediaDevices.getUserMedia({ audio: true })
    .then(stream => {
        const mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = event => {
            audioChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            sendDataToServer(audioBlob);
            audioChunks = []; // Reset the audio chunks after sending
        };

        $('#startRecord').on('click', function() {
            mediaRecorder.start();
            $(this).prop('disabled', true);
            $('#stopRecord').prop('disabled', false);
        });

        $('#stopRecord').on('click', function() {
            mediaRecorder.stop();
            $(this).prop('disabled', true);
            $('#startRecord').prop('disabled', false);
        });
    })
    .catch(error => {
        console.error('Error accessing the microphone:', error);
    });


function appendMessage(className, text) {
  // Create a new div for the message
  var messageDiv = $('<div></div>').addClass('message ' + className);
  messageDiv.text(text);

  // Append the message div to the transcription container
  $('#transcription').append(messageDiv);

  // Keep the scroll at the bottom
  $('#transcription').scrollTop($('#transcription')[0].scrollHeight);
}


function sendDataToServer(audioBlob) {
    let formData = new FormData();
    formData.append('audio', audioBlob);
    var aikey = localStorage.getItem('openaiKey');
    formData.append('key',aikey)

    $.ajax({
        type: 'POST',
        url: 'https://shloka.herokuapp.com/process_wav_js_key',  // This URL might need adjustment based on your setup
        data: formData,
        processData: false,
        contentType: false,
        success: function(transcription) {
            // $('#transcription').text('Transcription: ' + transcription);
            appendMessage('transcription', transcription);
            getAIresponse(transcription)
        },
        error: function(error) {
            console.error('Error sending data to server:', error);
        }
    });
}

function getAIresponse(transcription) {
    chatHistory.push({ role: 'user', content: transcription });

    if (chatHistory.length > 5) {
        chatHistory = [chatHistory[0], ...chatHistory.slice(-4)];
    }

    $.ajax({
        type: 'POST',
        url: 'https://api.openai.com/v1/chat/completions',
        data: JSON.stringify({ model: "gpt-4", messages: chatHistory }),
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer '+ localStorage.getItem('openaiKey')// Replace with your actual API key
        },
        success: function(aiResponse) {
            let responseText = aiResponse.choices[0].message.content.trim();
            console.log(responseText);
            // $('#transcription').text('Interviewee: ' + responseText);
            appendMessage('interviewee', responseText);

            // Call the ElevenLabs API to get the audio stream and play it
            getSpeechFromElevenLabs(responseText);
        },
        error: function(error) {
            console.error('Error getting AI Response:', error);
        }
    });
}


function getSpeechFromElevenLabs(text) {

    // let enhancedAudio = document.getElementById('ai-audio-checkbox').checked;
    let backgroundVideo = document.getElementById('background-video');

      const postData = {
            input: text,
            model: "tts-1",
            voice: "alloy"
        };

      fetch('https://api.openai.com/v1/audio/speech', {
            method: 'POST',
            headers: {
                'accept': 'audio/mpeg',
                'Authorization': 'Bearer '+ localStorage.getItem('openaiKey'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(postData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.blob();
        })
        .then(blob => {
            var audioUrl = URL.createObjectURL(blob);
            var audio = new Audio(audioUrl);
            audio.onplay = function() {
                backgroundVideo.play();
            };

            // Pause the video when the audio ends
            audio.onended = function() {
                backgroundVideo.pause();
            };
            audio.play();
        })
        .catch(error => {
            console.error('Error with ElevenLabs API:', error);
        });


    // if(enhancedAudio){
    //     const postData = {
    //         text: text,
    //         model_id: "eleven_monolingual_v1",
    //         voice_settings: {
    //             stability: 0,
    //             similarity_boost: 0,
    //             style: 0,
    //             use_speaker_boost: true
    //         }
    //     };

    //     fetch('https://api.elevenlabs.io/v1/text-to-speech/21m00Tcm4TlvDq8ikWAM/stream?optimize_streaming_latency=0&output_format=mp3_44100_128', {
    //         method: 'POST',
    //         headers: {
    //             'accept': 'audio/mpeg',
    //             'xi-api-key': localStorage.getItem('elevenLabsKey'), // Replace with your actual API key
    //             'Content-Type': 'application/json'
    //         },
    //         body: JSON.stringify(postData)
    //     })
    //     .then(response => {
    //         if (!response.ok) {
    //             throw new Error('Network response was not ok');
    //         }
    //         return response.blob();
    //     })
    //     .then(blob => {
    //         var audioUrl = URL.createObjectURL(blob);
    //         var audio = new Audio(audioUrl);
    //         audio.onplay = function() {
    //             backgroundVideo.play();
    //         };

    //         // Pause the video when the audio ends
    //         audio.onended = function() {
    //             backgroundVideo.pause();
    //         };
    //         audio.play();
    //     })
    //     .catch(error => {
    //         console.error('Error with ElevenLabs API:', error);
    //     });
    // }
    // else{
    //     let speech = new SpeechSynthesisUtterance(text);
    //     // speech.lang = 'en-US';
    //     speech.rate = 1; // Adjust the speech rate if needed
    //     window.speechSynthesis.speak(speech);
    // }
}

document.getElementById('download-btn').addEventListener('click', function() {
  // Get the transcription content
  var transcriptionContent = document.getElementById('transcription').innerHTML;

  // Convert the content to a Blob of type plain text
  var blob = new Blob([transcriptionContent], {
    type: 'text/plain;charset=utf-8'
  });

  // Create a temporary anchor element
  var tempLink = document.createElement('a');
  tempLink.download = 'transcription.txt'; // Name of the file to download
  tempLink.href = window.URL.createObjectURL(blob);

  // Temporarily add link to the body and trigger the download
  document.body.appendChild(tempLink);
  tempLink.click();

  // Clean up by removing the temporary link
  document.body.removeChild(tempLink);
});

    </script>
</body>
</html>