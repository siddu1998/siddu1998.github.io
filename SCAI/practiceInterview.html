<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Meeting</title>
  
</head>
<style>
    body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f3f4f6;
}

.meeting-container {
    display: flex;
    height: 100vh;
}

.user-panel, .virtual-character-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: stretch;
    justify-content: center;
    padding: 20px;
    border: 2px solid #e0e0e0;
    justify-content: space-between;
    
}

#userVideo {
    width: 40%;
    max-height: 40%;
    border-radius: 10px;
}

.controls {
    margin-top: 20px;
    display: inline-block;
}

.controls button {
    display: inline-block;
    margin: 5px;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    background-color: #2d2d2d;
    color: #ffffff;
    cursor: pointer;
    transition: background-color 0.3s;
}

.controls button:hover {
    background-color: #555555;
}
.system-message-container {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
}

#systemMessage {
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 14px;
    flex-grow: 1; /* Makes the textarea take all available space */
    margin-right: 10px; /* Spacing between textarea and button */
    outline: none; /* Removes the default focus outline */
    transition: border-color 0.3s ease; /* Smooth transition for focus effect */
}

#systemMessage:focus {
    border-color: #007BFF; /* Changes the border color when textarea is focused */
}
.hidden {
    display: none;
  }
#updateSystemMessage {
    padding: 10px 15px;
    background-color: #007BFF;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease; /* Smooth transition for hover effect */
}

#updateSystemMessage:hover {
    background-color: #0056b3; /* Slightly darker shade for hover */
}

.key-input-container {
    width: 300px;
    margin: 50px auto;
    padding: 20px;
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .form-group {
    margin-bottom: 10px;
  }
  label {
    display: block;
    margin-bottom: 5px;
  }
  input[type="text"] {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  input[type="password"] {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
  button {
    width: 100%;
    padding: 10px;
    border: none;
    background: #007bff;
    color: white;
    border-radius: 4px;
    cursor: pointer;
  }
  button:hover {
    background: #0056b3;
  }

  .checkbox-group {
    margin-bottom: 15px;
  }
  .checkbox-label {
    display: flex;
    align-items: center;
  }
  .checkbox-label input[type="checkbox"] {
    margin-right: 5px;
  }

  #transcription {
  background-color: #f5f5f5; /* light grey background for the whole chat */
  padding: 10px;
  border-radius: 5px;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

.message {
  padding: 10px;
  margin: 5px;
  border-radius: 8px;
  display: inline-block;
  max-width: 80%;
}

.interviewee {
  background-color: #c8e6c9; /* pastel green for interviewee */
  align-self: flex-end;
  margin-left: auto;
  word-wrap: break-word;
    align-self: flex-end;
    margin-left: auto;
}

.transcription {
  background-color: #bbdefb; /* pastel blue for AI */
  align-self: flex-start;
  margin-right: auto;
  word-wrap: break-word; /* Ensure long texts wrap */
}

/* Scroll to bottom automatically */
.autoscroll {
  scroll-behavior: smooth;
}
#download-btn {
  padding: 10px 20px;
  background-color: #e0e0e0; /* Light grey color */
  border: none;
  border-radius: 5px;
  cursor: pointer;
  margin: 10px 0;
}

#download-btn:hover {
  background-color: #d5d5d5; /* Slightly darker grey on hover */
}

.message-input {
    display: flex;
    width: 100%;
    gap: 10px; /* Space between elements */
}

#messageInput {
    flex-grow: 1;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px; /* Rounded corners */
    font-size: large;
}

#sendMessage {
    padding: 10px 20px;
    background-color: #4CAF50; /* Green background */
    color: white;
    border: none;
    border-radius: 5px; /* Rounded corners */
    cursor: pointer;
    font-size: large;
}

#sendMessage:hover {
    background-color: #45a049; /* Darker green on hover */
}

</style>

<body>
    
    <div class="meeting-container">
        <div class="key-input-container">
            
          <div class="form-group">
            <label for="Details">User Details:</label>
            <input type="text" id="student_id" placeholder="Enter your Assigned ID">
            <br>
            <br>
            <input type="text" id="session_id" placeholder="Enter your Session ID">
            <br>
            <br>
            <button id="submit-details">Submit Details</button>
          </div>
          
          <br>
          
          <div class="form-group">
              <label for="openai-key">AI API Key:</label>
              <input type="password" id="openai-key" placeholder="Enter your OpenAI key">
            </div>
            <!-- <div class="checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" id="ai-audio-checkbox">
                  Use AI Enhanced Audio
                </label>
              </div>
              <div class="form-group hidden" id="elevenlabs-key-group">
                <label for="elevenlabs-key">Enhanced Audio API Key:</label>
                <input type="password" id="elevenlabs-key" placeholder="Enter your ElevenLabs key">
              </div> -->

            <button id="submit-keys">Submit Keys</button>
            <br>
            <!-- <div class="form-group" style="padding-top: 10px;">
              <label for="systemMessage">Whom are you interviewing:</label>
              <textarea id="systemMessage" placeholder="Enter the role of your interviewee"></textarea>
            </div>
             -->
             <br>
             <button id="showCreateGptModal">+ Create New GPT</button>
             <div id="createGptModal" style="display:none;">
              <div>
                  <h2>Create New Custom GPT</h2>
                  <label for="gptName">Name:</label>
                  <input type="text" id="gptName" name="gptName"><br><br>
                  <label for="gptCreatedBy">Created By:</label>
                  <input type="text" id="gptCreatedBy" name="gptCreatedBy"><br><br>
                  <label for="gptUniversity">University:</label>
                  <input type="text" id="gptUniversity" name="gptUniversity"><br><br>
                  <label for="gptType">GPT Type:</label>
                  <input type="text" id="gptType" name="gptType"><br><br>
                  <label for="gptInstructions">Instructions:</label>
                  <textarea id="gptInstructions" name="gptInstructions"></textarea><br><br>
                  <button id="submitGptForm">Submit</button>
                  <button onclick="closeCreateGptModal()">Close</button>
              </div>
          </div>
          
            
              <div class="form-group" style="padding-top: 10px;">
                <label for="gptSelection">Choose a Custom GPT:</label>
                <select id="gptSelection">
                    <!-- Options will be populated here -->
                    
                </select>
              </div>          
             <button id="updateSystemMessage">Update System Message</button>
          </div>

          
        <div class="virtual-character-panel">
            
            <video id="background-video" width="100%" height="320" loop>
                <source src="images/womentalking.mp4" type="video/mp4">
                Your browser does not support the video tag.
              </video>
            <video id="userVideo" autoplay style="width: 100%; padding-top: 10%;"></video>
            <div class="controls">
                <!-- <button id="toggleCamera">Close Camera</button> -->
                <button id="startRecord">Start Recording</button>
                <button id="stopRecord" disabled>Stop Recording</button>
              
            </div>

        </div>
        
        <div class="user-panel">
            <button id="download-btn">Download Transcription</button>
            <div id="transcription" style="font-size: large; overflow-y: scroll; height: 100%;"></div>
            <div class="message-input">
              <input type="text" id="messageInput" placeholder="Type your message here...">
              <button id="sendMessage">Send</button>
          </div>
          </div>
       
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>


$(document).ready(function() {
    // Fetch and populate the dropdown with custom GPTs
    $.get('https://guiidata-b6c968e6ed85.herokuapp.com/datapipeline/api/list_custom_gpts/', function(gpts) {
        gpts.forEach(function(gpt) {
            $('#gptSelection').append(new Option(gpt.name, gpt.id));
        });
    });
});


  document.getElementById('submit-keys').onclick = function() {
    var openaiKey = document.getElementById('openai-key').value;
    localStorage.setItem('openaiKey', openaiKey);
  };

  document.getElementById('submit-details').addEventListener('click', function() {
        // Retrieve the values from the input fields
        var studentId = document.getElementById('student_id').value;
        var sessionId = document.getElementById('session_id').value;

        // Store the values in local storage
        localStorage.setItem('studentId', studentId);
        localStorage.setItem('sessionId', sessionId);

        // Optional: Confirmation or further actions after storing
        console.log('Details submitted and stored in local storage.');
    });

  function openCreateGptModal() {
    document.getElementById('createGptModal').style.display = 'block';
}






const toggleCameraButton = document.getElementById('toggleCamera');
navigator.mediaDevices.getUserMedia({ video: true})
    .then(localStream => {
        stream = localStream;
        userVideo.srcObject = localStream;
    })
    .catch(error => {
        console.error('Error accessing the camera or microphone:', error);
    });


        
let audioChunks = [];
// let chatHistory = [{
//     role: 'system',
//     content: 'You are a helpful teacher assisting with interview preparations.'}
// ];
// $('#updateSystemMessage').on('click', function() {
//     const systemContent = $('#systemMessage').val().trim();
//     var prompt = 'I am a student and a researcher practicing my ability to conduct UX research interviews skills. I will need you to respond to various questions I ask. Respond very natuarlly to mimic a scenario in a real life interview, feel free to have filler words. You are being interviewed and make sure you act like the persona you are assigned, you are free to make up responses.'
//     if (systemContent) {
//         chatHistory = [
//             {role: 'system', content: prompt + ' ' + systemContent}
//         ];
//         console.log('updated system role')
//     } else {
//         console.log('Failed to update system role');
//     }
// });


function openCreateGptModal() {
    document.getElementById('createGptModal').style.display = 'block';
}

// Function to close the modal
function closeCreateGptModal() {
    document.getElementById('createGptModal').style.display = 'none';
}

// Event listener for opening the modal
document.getElementById('showCreateGptModal').addEventListener('click', openCreateGptModal);

// Event listener for form submission
document.getElementById('submitGptForm').addEventListener('click', function() {
    var data = {
        name: document.getElementById('gptName').value,
        created_by: document.getElementById('gptCreatedBy').value,
        university: document.getElementById('gptUniversity').value,
        gpt_type: document.getElementById('gptType').value,
        instructions: document.getElementById('gptInstructions').value
    };

    // AJAX call to send data to the server
    $.ajax({
        type: "POST",
        url: "https://guiidata-b6c968e6ed85.herokuapp.com/datapipeline/api/create_new_gpt/",
        data: JSON.stringify(data),
        contentType: "application/json",
        success: function(response) {
            console.log(response);
            closeCreateGptModal();
            // Optional: Refresh the list or update the UI accordingly
        },
        error: function(error) {
            console.error("Error creating Custom GPT:", error);
        }
    });
});



$('#updateSystemMessage').on('click', function() {
    const selectedGptId = $('#gptSelection').val();
    $.get('https://guiidata-b6c968e6ed85.herokuapp.com/datapipeline/api/list_custom_gpts/', function(gpts) {
        const selectedGpt = gpts.find(g => g.id == selectedGptId);
        if (selectedGpt) {
            chatHistory = [
                {role: 'system', content: selectedGpt.instructions}
            ];
            console.log('updated system role');
        } else {
            console.log('Failed to update system role');
        }
    });
});

navigator.mediaDevices.getUserMedia({ audio: true })
    .then(stream => {
        const mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = event => {
            audioChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            getTextFromSpeech(audioBlob);
            audioChunks = []; // Reset the audio chunks after sending
        };

        $('#startRecord').on('click', function() {
            mediaRecorder.start();
            $(this).prop('disabled', true);
            $('#stopRecord').prop('disabled', false);
        });

        $('#stopRecord').on('click', function() {
            mediaRecorder.stop();
            $(this).prop('disabled', true);
            $('#startRecord').prop('disabled', false);
        });
    })
    .catch(error => {
        console.error('Error accessing the microphone:', error);
    });




  


function sendMessageToStorage(content){
  var data = {
                session_id: localStorage.getItem('sessionId'),
                student_id: localStorage.getItem('studentId'),
                content: content
            };

            $.ajax({
                url: 'https://guiidata-b6c968e6ed85.herokuapp.com/datapipeline/api/message/',  // Update with your correct URL
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(response) {
                    console.log("Message sent successfully:", response);
                },
                error: function(error) {
                    console.error("Error sending message:", error);
                }
            });
}



function appendMessage(className, text) {
  // Create a new div for the message
  var messageDiv = $('<div></div>').addClass('message ' + className);
  messageDiv.text(text);

  // Append the message div to the transcription container
  $('#transcription').append(messageDiv);
  $('#transcription').append('<br>');
  
  // Keep the scroll at the bottom
  $('#transcription').scrollTop($('#transcription')[0].scrollHeight);
}





function getTextFromSpeech(audioBlob) {
    let formData = new FormData();
    formData.append('file', audioBlob,'recording.wav');
    var aikey = localStorage.getItem('openaiKey');
    formData.append('model', 'whisper-1');

    $.ajax({
        url: 'https://api.openai.com/v1/audio/transcriptions',
        type: 'POST',
        data: formData,
        processData: false, // prevent jQuery from converting the data into a query string
        contentType: false, // set to false as jQuery will set the Content-Type correctly with FormData
        headers: {
            'Authorization': 'Bearer ' + aikey // Replace with your OpenAI API key
        },
        success: function (data) {
              console.log(data);
              var transcription = data.text
              appendMessage('transcription', transcription);
              sendMessageToStorage(transcription)
              getAIresponse(transcription)
        },
        error: function (error) {
            console.error('Error:', error);
        }
    });
}





$('#sendMessage').on('click', function() {
        // Get the message from the input
        var message = $('#messageInput').val().trim();

        // Check if the message is not empty
        if (message) {
            // Append the message as a user message
            appendMessage('transcription', message);
            $('#messageInput').val('');
            sendMessageToStorage(message)
            getAIresponse(message)
        }
    });

    // Optional: Send message when 'Enter' is pressed
    $('#messageInput').on('keypress', function(e) {
        if (e.which == 13) { // Enter key
            $('#sendMessage').click();
        }
    });





function getAIresponse(transcription) {
    chatHistory.push({ role: 'user', content: transcription });

    if (chatHistory.length > 5) {
        chatHistory = [chatHistory[0], ...chatHistory.slice(-4)];
    }

    $.ajax({
        type: 'POST',
        url: 'https://api.openai.com/v1/chat/completions',
        data: JSON.stringify({ model: "gpt-4", messages: chatHistory }),
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer '+ localStorage.getItem('openaiKey')// Replace with your actual API key
        },
        success: function(aiResponse) {
            let responseText = aiResponse.choices[0].message.content.trim();
            console.log(responseText);
            // $('#transcription').text('Interviewee: ' + responseText);
            appendMessage('interviewee', responseText);
            sendMessageToStorage(responseText)
            chatHistory.push({ role: 'system', content: responseText });
            console.log(chatHistory)
            // Call the ElevenLabs API to get the audio stream and play it
            getSpeechFromText(responseText);
        },
        error: function(error) {
            console.error('Error getting AI Response:', error);
        }
    });
}


function getSpeechFromText(text) {

    // let enhancedAudio = document.getElementById('ai-audio-checkbox').checked;
    let backgroundVideo = document.getElementById('background-video');

      const postData = {
            input: text,
            model: "tts-1",
            voice: "alloy"
        };

      fetch('https://api.openai.com/v1/audio/speech', {
            method: 'POST',
            headers: {
                'accept': 'audio/mpeg',
                'Authorization': 'Bearer '+ localStorage.getItem('openaiKey'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(postData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.blob();
        })
        .then(blob => {
            var audioUrl = URL.createObjectURL(blob);
            var audio = new Audio(audioUrl);
            audio.onplay = function() {
                backgroundVideo.play();
            };

            // Pause the video when the audio ends
            audio.onended = function() {
                backgroundVideo.pause();
            };
            audio.play();
        })
        .catch(error => {
            console.error('Error with ElevenLabs API:', error);
        });

}






document.getElementById('download-btn').addEventListener('click', function() {
  var transcriptionContent = document.getElementById('transcription').innerHTML;
  var blob = new Blob([transcriptionContent], {
    type: 'text/plain;charset=utf-8'
  });
  var tempLink = document.createElement('a');
  tempLink.download = 'transcription.txt'; // Name of the file to download
  tempLink.href = window.URL.createObjectURL(blob);

  // Temporarily add link to the body and trigger the download
  document.body.appendChild(tempLink);
  tempLink.click();

  // Clean up by removing the temporary link
  document.body.removeChild(tempLink);
});

    </script>
</body>
</html>