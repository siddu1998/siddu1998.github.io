<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyCreator</title>
    <style>
        * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    display: flex;
    height: 100vh;
    color: #2c3e50;
}

.sidebar {
    width: 30%;
    background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
    padding: 24px;
    border-right: 1px solid rgba(226, 232, 240, 0.8);
    height: 100vh;
    overflow-y: auto;
    box-shadow: 4px 0 20px rgba(0, 0, 0, 0.05);
    backdrop-filter: blur(10px);
}

.main-content {
    width: 70%;
    display: flex;
    flex-direction: column;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.navbar {
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(45, 52, 54, 0.95) 100%);
    padding: 16px 24px;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.navbar input[type="text"] {
    padding: 12px 16px;
    border: none;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.15);
    color: white;
    font-size: 14px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
}

.navbar input[type="text"]:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.4);
    transform: scale(1.02);
}

.navbar input[type="text"]::placeholder {
    color: rgba(255, 255, 255, 0.7);
}

.navbar select {
    padding: 12px 16px;
    border: none;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.15);
    color: white;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
}

.navbar select:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.4);
}

.chat-window {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
    backdrop-filter: blur(20px);
}

.dynamic-responses {
    display: flex;
    justify-content: space-around;
    padding: 16px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
}

.response-button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.response-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
}


        .message-input-area {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            position: sticky;
            bottom: 0;
            gap: 10px;
        }


textarea {
    flex: 1;
    padding: 16px 20px;
    border: none;
    border-radius: 20px;
    background: rgba(255, 255, 255, 0.9);
    resize: none;
    min-height: 50px;
    font-family: inherit;
    font-size: 14px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
}

textarea:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.95);
    transform: scale(1.01);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
}

textarea::placeholder {
    color: #94a3b8;
}

button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 16px 24px;
    border: none;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
}

button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}


        .user-message {
            background: linear-gradient(135deg, #e6fffa 0%, #b2f5ea 100%);
            padding: 16px 20px;
            border-radius: 18px 18px 4px 18px;
            max-width: 80%;
            margin-bottom: 16px;
            word-wrap: break-word;
            align-self: flex-end;
            margin-left: auto;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            font-size: 14px;
            line-height: 1.6;
        }

        .user-message-ai {
            background: linear-gradient(135deg, #e6fffa 0%, #b2f5ea 100%);
            padding: 16px 20px;
            border-radius: 18px 18px 4px 18px;
            max-width: 80%;
            margin-bottom: 16px;
            word-wrap: break-word;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            font-size: 14px;
            line-height: 1.6;
        }

            .ai-message {
    background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
    padding: 16px 20px;
    border-radius: 20px 20px 20px 8px;
    max-width: 80%;
    margin: 8px auto 8px 0;
    word-wrap: break-word;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    animation: slideInLeft 0.3s ease;
}


.form-container {
    padding: 24px;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 250, 252, 0.9) 100%);
    border: 1px solid rgba(226, 232, 240, 0.5);
    border-radius: 16px;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
}

.form-container.light-yellow {
    background: linear-gradient(135deg, rgba(255, 248, 179, 0.9) 0%, rgba(255, 235, 59, 0.1) 100%);
    border-color: rgba(255, 193, 7, 0.3);
    box-shadow: 0 4px 20px rgba(255, 193, 7, 0.1);
}

.form-container input, .form-container textarea {
    width: 100%;
    padding: 14px 16px;
    margin: 8px 0 16px 0;
    border: 1px solid rgba(203, 213, 225, 0.5);
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.8);
    font-family: inherit;
    font-size: 14px;
    transition: all 0.3s ease;
    backdrop-filter: blur(5px);
}

.form-container input:focus, .form-container textarea:focus {
    outline: none;
    border-color: #667eea;
    background: rgba(255, 255, 255, 0.95);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    transform: scale(1.005);
}

.form-container button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 14px 24px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    width: 100%;
    margin-top: 8px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.form-container button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
}

.prompt-selector {
    margin: 20px 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 250, 252, 0.9) 100%);
    padding: 20px;
    border: 1px solid rgba(226, 232, 240, 0.5);
    border-radius: 16px;
    backdrop-filter: blur(10px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
}

.prompt-selector select {
    width: 100%;
    padding: 14px 16px;
    border-radius: 12px;
    margin-bottom: 16px;
    border: 1px solid rgba(203, 213, 225, 0.5);
    background: rgba(255, 255, 255, 0.8);
    font-family: inherit;
    font-size: 14px;
    transition: all 0.3s ease;
}

.prompt-selector select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

#selectedPrompt {
    margin: 16px 0;
    padding: 16px;
    background: linear-gradient(135deg, rgba(248, 250, 252, 0.8) 0%, rgba(241, 245, 249, 0.8) 100%);
    border: 1px solid rgba(203, 213, 225, 0.3);
    border-radius: 12px;
    min-height: 60px;
    font-size: 14px;
    line-height: 1.6;
    backdrop-filter: blur(5px);
}

#selectedPrompt em {
    color: #64748b;
    font-style: italic;
}

h1 {
    font-size: 28px;
    font-weight: 700;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 8px;
}

h3 {
    font-size: 18px;
    font-weight: 600;
    color: #374151;
    margin: 24px 0 16px 0;
}

h4 {
    font-size: 16px;
    font-weight: 600;
    color: #374151;
    margin: 16px 0 8px 0;
}

label {
    display: block;
    font-weight: 500;
    color: #374151;
    margin-bottom: 6px;
    font-size: 14px;
}

#result {
    margin-top: 16px;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
}

/* Scrollbar Styling */
::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-track {
    background: rgba(241, 245, 249, 0.5);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
    border-radius: 4px;
    transition: all 0.3s ease;
}

::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
}

/* Toggle Switch Styling */
input[type="checkbox"] {
    appearance: none;
    width: 50px;
    height: 24px;
    background: #cbd5e1;
    border-radius: 12px;
    position: relative;
    cursor: pointer;
    transition: all 0.3s ease;
}

input[type="checkbox"]:checked {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

input[type="checkbox"]:before {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: white;
    top: 2px;
    left: 2px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

input[type="checkbox"]:checked:before {
    transform: translateX(26px);
}

/* Animation for form transitions */
#regularPromptSection, #aiPromptSection {
    transition: all 0.3s ease;
}

/* Responsive Design */
@media (max-width: 768px) {
    body {
        flex-direction: column;
    }
    
    .sidebar {
        width: 100%;
        height: auto;
    }
    
    .main-content {
        width: 100%;
    }
    
    .navbar {
        flex-direction: column;
        gap: 12px;
    }
    
    .message-input-area {
        flex-direction: column;
    }
    
    .user-message, .ai-message {
        max-width: 95%;
    }
}
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.16/marked.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js"
        onload="renderMathInElement(document.body);"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
    <!-- Side Navigation Bar -->
    <div class="sidebar">
        <h1>StudyCreator</h1>
        <br>

        <h3>Existing Prompts</h3>
        <div class="prompt-selector">
            <select id="existingPrompts">
                <option value="">Select a Prompt</option>
            </select>
            <div id="selectedPrompt" style="margin: 10px 0; padding: 10px; background: #f9f9f9; border: 1px solid #ccc; border-radius: 5px; min-height: 50px;">
                <em>Selected prompt will appear here...</em>
            </div>
            <button id="copyPrompt" disabled>Copy Prompt</button>
        </div>

        <h3>Create a Custom GPT</h3>
        <div style="display: flex; align-items: center; gap: 10px;">
            <label for="useAiToggle">Use AI to Create Better Prompts:</label>
            <input type="checkbox" id="useAiToggle">
        </div>
        <div class="form-container" id="formContainer">
            
        
            <form id="customGPTForm">
                <!-- Shared Fields -->
                <label for="name">Name:</label>
                <input type="text" id="name" name="name" required>
                
                <label for="created_by">Created By:</label>
                <input type="text" id="created_by" name="created_by" required>
                
                <label for="university">University:</label>
                <input type="text" id="university" name="university" required>
                
                <label for="gpt_type">GPT Type:</label>
                <input type="text" id="gpt_type" name="gpt_type" required>
        
                <!-- Regular Prompt Section -->
                <div id="regularPromptSection">
                    <label for="instructions">Instructions:</label>
                    <textarea id="instructions" name="instructions" required style="overflow: hidden; resize: none;"></textarea>
                </div>
        
                <!-- AI-Powered Prompt Section -->
                <div id="aiPromptSection" style="display: none;">
                    <label for="role">Role:</label>
                    <input type="text" id="role" placeholder="E.g., a statistics tutor">
        
                    <label for="topicsToTeach">Topics to Teach:</label>
                    <textarea id="topicsToTeach" placeholder="E.g., t-tests, ANOVA"></textarea>
        
                    <label for="topicsNotToTeach">Topics Not to Teach:</label>
                    <textarea id="topicsNotToTeach" placeholder="E.g., Pearson coefficient"></textarea>
        
                    <label for="botConstraints">Bot Constraints:</label>
                    <textarea id="botConstraints" placeholder="E.g., Avoid using jargon"></textarea>
        
                    <label for="stepByStepInstructions">Step-by-Step Instructions:</label>
                    <textarea id="stepByStepInstructions" placeholder="E.g., Introduce concepts, provide examples"></textarea>
        
                    <label for="tone">Tone:</label>
                    <input type="text" id="tone" placeholder="E.g., Friendly, supportive">
        
                    <label for="exampleInteractions">Example Interactions:</label>
                    <textarea id="exampleInteractions" placeholder="E.g., Q: What is a t-test?"></textarea>
        
                    <label for="otherInstructions">Other Instructions:</label>
                    <textarea id="otherInstructions" placeholder="Any other details"></textarea>
        
                    <label for="botIntroduction">Bot Introduction:</label>
                    <textarea id="botIntroduction" placeholder="E.g., Hi, Iâ€™m here to help you learn statistics!"></textarea>
        
                    <button type="button" id="generatePrompt">Generate Prompt</button>
                    <h4>Generated Prompt:</h4>
                    <textarea id="generatedPrompt" style="overflow: hidden; resize: none;"></textarea>
                </div>
        
                <button type="submit">Create Custom GPT</button>
            </form>
            <p id="result"></p>
        </div>
        
        
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <div class="navbar">
            <input type="text" id="studentId" placeholder="Enter StudyCrafter ID">
            <select id="gptSelection">
                <option value="">Select Activity</option>
            </select>
        </div>

        <div id="transcription" class="chat-window"></div>

        <!-- <div id="dynamic-responses" class="dynamic-responses"></div> -->

        <div class="message-input-area">
            <textarea id="messageInput" placeholder="Type your message here..."></textarea>
            <button id="sendMessage" disabled>Send</button>
            <button id="download-btn">Download Transcript</button>
        </div>
    </div>

    <script>

//
document.addEventListener("DOMContentLoaded", function () {
const instructionsTextarea = document.getElementById("instructions");

// Automatically adjust the height of the textarea based on content
instructionsTextarea.addEventListener("input", function () {
    this.style.height = "auto"; // Reset the height
    this.style.height = this.scrollHeight + "px"; // Set it to the scroll height
});
});

    document.addEventListener("DOMContentLoaded", function () {
    const useAiToggle = document.getElementById("useAiToggle");
    const regularPromptSection = document.getElementById("regularPromptSection");
    const aiPromptSection = document.getElementById("aiPromptSection");
    const instructionsField = document.getElementById("instructions");
    const generatedPromptField = document.getElementById("generatedPrompt");
    const generatePromptButton = document.getElementById("generatePrompt");

    const formContainer = document.getElementById("formContainer");

   // Toggle between regular and AI prompt creation
   useAiToggle.addEventListener("change", function () {
        document.getElementById("name").value = "";
        document.getElementById("created_by").value = "";
        document.getElementById("university").value = "";
        document.getElementById("gpt_type").value = "";
        document.getElementById("role").value = "";
        document.getElementById("topicsToTeach").value = "";
        document.getElementById("topicsNotToTeach").value = "";
        document.getElementById("botConstraints").value = "";
        document.getElementById("stepByStepInstructions").value = "";
        document.getElementById("tone").value = "";
        document.getElementById("exampleInteractions").value = "";
        document.getElementById("otherInstructions").value = "";
        document.getElementById("botIntroduction").value = "";
        document.getElementById("generatedPrompt").value="";
        document.getElementById("instructions").value=""

        if (useAiToggle.checked) {
            formContainer.classList.add("light-yellow");
            regularPromptSection.style.display = "none";
            aiPromptSection.style.display = "block";
            instructionsField.removeAttribute("required"); // Remove required from the regular field
            generatedPromptField.setAttribute("required", "true"); // Make the generated prompt required
        } else {
            formContainer.classList.remove("light-yellow");
            regularPromptSection.style.display = "block";
            aiPromptSection.style.display = "none";
            instructionsField.setAttribute("required", "true"); // Make the regular field required
            generatedPromptField.removeAttribute("required"); // Remove required from the generated prompt
        }
    });

    // Generate prompt using OpenAI API
    generatePromptButton.addEventListener("click", async function () {
        const role = document.getElementById("role").value.trim();
        const topicsToTeach = document.getElementById("topicsToTeach").value.trim();
        const topicsNotToTeach = document.getElementById("topicsNotToTeach").value.trim();
        const botConstraints = document.getElementById("botConstraints").value.trim();
        const stepByStepInstructions = document.getElementById("stepByStepInstructions").value.trim();
        const tone = document.getElementById("tone").value.trim();
        const exampleInteractions = document.getElementById("exampleInteractions").value.trim();
        const otherInstructions = document.getElementById("otherInstructions").value.trim();
        const botIntroduction = document.getElementById("botIntroduction").value.trim();

        const promptParts = [
            `Role: ${role || "N/A"}`,
            `Topics to Teach: ${topicsToTeach || "N/A"}`,
            `Topics Not to Teach: ${topicsNotToTeach || "N/A"}`,
            `Constraints for the new AI-bot: ${botConstraints || "N/A"}`,
            `Step-by-Step Instructions: ${stepByStepInstructions || "N/A"}`,
            `Tone: ${tone || "N/A"}`,
            `Example Interactions: ${exampleInteractions || "N/A"}`,
            `Other Instructions: ${otherInstructions || "N/A"}`,
            `Bot Introduction: ${botIntroduction || "N/A"}`
        ].join("\n\n");

        try {
            const response = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + localStorage.getItem("openaiKey")
                },
                body: JSON.stringify({
                    model: "gpt-4o",
                    messages: [
                        {
                            role: "system",
                            content: "For the above details, generate a prompt I can feed an AI bot to behave according to the above constraints and rules. You are allowed to be creative and and elaborate to make sure the prompt behaves accordingly. Keep your responses under 7000 characters."
                        },
                        {
                            role: "user",
                            content: promptParts
                        }
                    ]
                })
            });

            if (response.ok) {
                const result = await response.json();
                const aiGeneratedPrompt = result.choices[0].message.content.trim();
                generatedPromptField.value = aiGeneratedPrompt;
                generatedPromptField.style.height = "auto";
                generatedPromptField.style.height = generatedPromptField.scrollHeight + "px";
            } else {
                const errorText = await response.text();
                alert("Error generating prompt: " + errorText);
            }
        } catch (error) {
            alert("Error: " + error.message);
        }
    });

    // Automatically adjust textarea height for all textareas
    document.querySelectorAll("textarea").forEach(function (textarea) {
        textarea.addEventListener("input", function () {
            this.style.height = "auto";
            this.style.height = this.scrollHeight + "px";
        });
    });
});

//Custom GPT Creator Logic
const form = document.getElementById("customGPTForm");
    form.addEventListener("submit", async function (event) {
        event.preventDefault();

        const name = document.getElementById("name").value.trim();
        const createdBy = document.getElementById("created_by").value.trim();
        const university = document.getElementById("university").value.trim();
        const gptType = document.getElementById("gpt_type").value.trim();

        let instructionsToSend = ""
        // Use AI-generated or regular instructions
        if(useAiToggle.checked){
             instructionsToSend = document.getElementById("generatedPrompt").value.trim()
        }
        else{
             instructionsToSend= document.getElementById("instructions").value.trim()
        }

        console.log(instructionsToSend)

        const formData = {
            name,
            created_by: createdBy,
            university,
            gpt_type: gptType,
            instructions: instructionsToSend
        };

        try {
            const response = await fetch("https://guiidata-b6c968e6ed85.herokuapp.com/datapipeline/api/create_new_gpt/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                const result = await response.json();
                document.getElementById("result").textContent = "Custom GPT created successfully with ID: " + result.id;
            } else {
                const errorText = await response.text();
                document.getElementById("result").textContent = "Error: " + errorText;
            }
        } catch (error) {
            document.getElementById("result").textContent = "Error: " + error.message;
        }
    });




        //StudyHelper Logic

        let chatHistory = [];
        $(document).ready(function () {

            var uniqueID = 'id_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('sessionID', uniqueID);

            $.get('https://guiidata-b6c968e6ed85.herokuapp.com/datapipeline/api/list_custom_gpts/', function (gpts) {
                gpts.forEach(function (gpt) {
                    $('#existingPrompts').append(new Option(gpt.name, gpt.instructions));
                });
            });

            // Enable copy button when a prompt is selected
            $('#existingPrompts').on('change', function () {
                const selectedPrompt = $(this).val(); // Get selected data from dropdown
                const displayArea = $('#selectedPrompt'); // Target display area

                if (selectedPrompt) {
                    // Use marked.parse to render paragraphs and lists properly
                    const parsedContent = marked.parse(selectedPrompt); 
                    displayArea.html(parsedContent); // Dynamically render as HTML
                    $('#copyPrompt').prop('disabled', false);
                } else {
                    displayArea.html('<em>Selected prompt will appear here...</em>');
                    $('#copyPrompt').prop('disabled', true);
                }
            });


            // Copy selected prompt to clipboard
            $('#copyPrompt').on('click', function () {
                const selectedPrompt = $('#existingPrompts').val();
                if (selectedPrompt) {
                    navigator.clipboard.writeText(selectedPrompt).then(() => {
                        alert('Prompt copied to clipboard!');
                    }).catch(err => {
                        console.error('Error copying prompt:', err);
                    });
                }
            });




            // Fetch API key and GPT options
            $.get('https://guiidata-b6c968e6ed85.herokuapp.com/datapipeline/api/getOAI/', function (data) {
                localStorage.setItem('openaiKey', data.key);
                console.log('Key set');
            });

            $.get('https://guiidata-b6c968e6ed85.herokuapp.com/datapipeline/api/list_custom_gpts/', function (gpts) {
                gpts.forEach(function (gpt) {
                    $('#gptSelection').append(new Option(gpt.name, gpt.id));
                });
            });

            // Disable inputs until a valid ID is entered
            $('#gptSelection, #messageInput, #sendMessage, #download-btn').prop('disabled', true);

            // Enable inputs after valid ID is entered
            $('#studentId').on('input', function () {
                const studentId = $(this).val().trim();
                const isValidId = studentId.length > 0; // Replace with your custom validation logic if needed
                $('#gptSelection, #messageInput, #sendMessage, #download-btn').prop('disabled', !isValidId);
            });

            $('#gptSelection').on('change', function () {
                const selectedGptId = $(this).val();
                if (!selectedGptId) return;

                $.get('https://guiidata-b6c968e6ed85.herokuapp.com/datapipeline/api/list_custom_gpts/', function (gpts) {
                    const selectedGpt = gpts.find(g => g.id == selectedGptId);
                    if (selectedGpt) {
                        localStorage.setItem('selectedGPT', selectedGpt.name);
                        chatHistory.push({ role: 'system', content: selectedGpt.instructions });
                        generateIntroductoryMessage(selectedGpt.instructions);
                    }
                });
            });

            // Send Message
            $('#sendMessage').on('click', function () {
                var message = $('#messageInput').val().trim();
                if (message) {
                    chatHistory.push({ role: 'user', content: message });
                    appendMessage('user-message', message);
                    $('#messageInput').val('');
                    getAIresponse(message);
                }
            });

            $('#messageInput').on('keypress', function (e) {
                if (e.which == 13) {
                    $('#sendMessage').click();
                }
            });

            function generateIntroductoryMessage(instructions) {
                $.ajax({
                    type: 'POST',
                    url: 'https://api.openai.com/v1/chat/completions',
                    data: JSON.stringify({
                        model: "gpt-4o",
                        messages: [{
                            role: 'system',
                            content: instructions + ": For the above instructions generate an introductory message, welcoming the student and setting the context of this session, keep it short and neat."
                        }]
                    }),
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('openaiKey')
                    },
                    success: function (aiResponse) {
                        let introMessage = aiResponse.choices[0].message.content.trim();
                        appendMessage('ai-message', introMessage);
                        chatHistory.push({ role: 'system', content: introMessage });
                    }
                });
            }

            function appendMessage(className, message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = className;

                // Parse Markdown for AI messages and plain text for user messages
                if (className === 'ai-message') {
                    messageDiv.innerHTML = marked.parse(message);

                    // Render math expressions using KaTeX
                    renderMathInElement(messageDiv, {
                        delimiters: [
                            { left: "$$", right: "$$", display: true },
                            { left: "$", right: "$", display: false }
                        ]
                    });
                } else {
                    messageDiv.textContent = message;
                }

                // Append the message and scroll to bottom
                document.getElementById('transcription').appendChild(messageDiv);
                scrollToBottom();

                // Store message to the database
                //storeData(message, className);
            }

            function storeData(content, sentBy) {
                const studentId = $('#studentId').val();
                const data = {
                    session_id: localStorage.getItem('sessionID'),
                    student_id: studentId,
                    sent_by: sentBy,
                    content: content,
                    gpt_used: localStorage.getItem('selectedGPT')
                };

                $.ajax({
                    type: 'POST',
                    url: 'https://guiidata-b6c968e6ed85.herokuapp.com/datapipeline/api/message/',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function (response) {
                        console.log('Message stored:', response);
                    },
                    error: function (xhr, status, error) {
                        console.error('Error storing message:', error);
                    }
                });
            }

            function getAIresponse(transcription) {
                const maxCharacterLimit = 6000;
                let totalCharacterLength = chatHistory.slice(1).reduce((acc, msg) => acc + msg.content.length, 0);

                while (totalCharacterLength > maxCharacterLimit) {
                    chatHistory.splice(1, 1);

                    totalCharacterLength = chatHistory.slice(1).reduce((acc, msg) => acc + msg.content.length, 0);
                }

                $.ajax({
                    type: 'POST',
                    url: 'https://api.openai.com/v1/chat/completions',
                    data: JSON.stringify({
                        model: "gpt-4o",
                        messages: chatHistory
                    }),
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('openaiKey')
                    },
                    success: function (aiResponse) {
                        let responseText = aiResponse.choices[0].message.content.trim();
                        appendMessage('ai-message', responseText);
                        chatHistory.push({ role: 'assistant', content: responseText });
                    }
                });
            }

            function scrollToBottom() {
                const chatWindow = document.getElementById("transcription");
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            // Download Transcript Functionality
            document.getElementById('download-btn').addEventListener('click', function () {
                var transcriptionContent = document.getElementById('transcription').innerHTML;

                var css = `
                body { font-family: 'Arial', sans-serif; background: #f4f4f4; color: #333; }
                .user-message { background-color: #c8e6c9; align-self: flex-end; margin-left: auto; word-wrap: break-word; }
                .ai-message { background-color: #bbdefb; align-self: flex-start; margin-right: auto; word-wrap: break-word; }`;

                var htmlContentWithCSS = `<html><head><style>${css}</style></head><body>${transcriptionContent}</body></html>`;

                var blob = new Blob([htmlContentWithCSS], {
                    type: 'text/html'
                });
                var tempLink = document.createElement('a');
                tempLink.download = 'transcript.html';
                tempLink.href = window.URL.createObjectURL(blob);

                // Temporarily add link to the body and trigger the download
                document.body.appendChild(tempLink);
                tempLink.click();

                // Clean up by removing the temporary link
                document.body.removeChild(tempLink);
            });
        });
    </script>
</body>

</html>
