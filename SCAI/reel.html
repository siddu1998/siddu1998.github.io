<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Video Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .video-clip, .image-clip {
            position: relative;
            overflow: hidden;
            border-radius: 0.5rem;
            background-color: #e0e0e0; /* Placeholder background */
        }
        .clip-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 0.5rem;
            font-size: 0.875rem;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
        }
        .video-clip:hover .clip-overlay, .image-clip:hover .clip-overlay {
            transform: translateY(0);
        }
    </style>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">AI Video Generator</h1>
            <p class="text-lg text-gray-600 mt-2">Bring your stories to life with the power of Google's Generative AI</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Control Panel -->
            <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-6">Create Your Video</h2>

                <div class="space-y-6">
                    <div>
                        <label for="apiKey" class="block text-sm font-medium text-gray-700 mb-1">Gemini API Key</label>
                        <input type="password" id="apiKey" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Enter your API key">
                    </div>

                    <div>
                        <label for="videoContext" class="block text-sm font-medium text-gray-700 mb-1">Video Context</label>
                        <textarea id="videoContext" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., A futuristic city with flying cars and neon lights"></textarea>
                    </div>
                    
                    <div>
                        <label for="artStyle" class="block text-sm font-medium text-gray-700 mb-1">Art Style</label>
                        <select id="artStyle" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option>Cinematic</option>
                            <option>Anime</option>
                            <option>Photorealistic</option>
                            <option>Fantasy</option>
                            <option>Watercolor</option>
                        </select>
                    </div>

                    <div>
                        <label for="voice" class="block text-sm font-medium text-gray-700 mb-1">Voice</label>
                        <select id="voice" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                             <option value="Kore">Kore (Firm)</option>
                             <option value="Puck">Puck (Upbeat)</option>
                             <option value="Zephyr">Zephyr (Bright)</option>
                             <option value="Charon">Charon (Informative)</option>
                        </select>
                    </div>

                    <button id="generateBtn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        Generate Video
                    </button>
                </div>
            </div>

            <!-- Video Player and Editor -->
            <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-lg">
                <div id="videoPlayerContainer" class="mb-6 bg-black rounded-lg overflow-hidden">
                    <div id="videoPlayer" class="aspect-w-16 aspect-h-9 flex items-center justify-center">
                       <p class="text-white">Your generated video will appear here.</p>
                    </div>
                     <div id="audioPlayerContainer"></div>
                </div>

                <div id="loader" class="hidden loader"></div>
                <div id="errorMessage" class="hidden text-red-500 text-center p-4 bg-red-100 rounded-md"></div>

                <h3 class="text-xl font-semibold mb-4">Clip Editor</h3>
                <div id="clipEditor" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Clips will be dynamically inserted here -->
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const apiKeyInput = document.getElementById('apiKey');
            const videoContextInput = document.getElementById('videoContext');
            const artStyleSelect = document.getElementById('artStyle');
            const voiceSelect = document.getElementById('voice');
            const generateBtn = document.getElementById('generateBtn');
            const videoPlayer = document.getElementById('videoPlayer');
            const audioPlayerContainer = document.getElementById('audioPlayerContainer');
            const clipEditor = document.getElementById('clipEditor');
            const loader = document.getElementById('loader');
            const errorMessage = document.getElementById('errorMessage');

            let clipsData = [];

            const instagramHooks = [
                "You won't believe what happens next...",
                "The biggest mistake people make when...",
                "Here's a secret they don't want you to know about...",
                "I tried the viral trend, and here's what happened...",
                "Stop scrolling! You need to hear this..."
            ];

            generateBtn.addEventListener('click', async () => {
                const apiKey = apiKeyInput.value.trim();
                const context = videoContextInput.value.trim();

                if (!apiKey || !context) {
                    showError("Please provide both an API key and a video context.");
                    return;
                }

                showLoader(true);
                clearError();
                clipEditor.innerHTML = '';
                videoPlayer.innerHTML = '<p class="text-white">Generating your video...</p>';
                audioPlayerContainer.innerHTML = '';

                try {
                    const randomHook = instagramHooks[Math.floor(Math.random() * instagramHooks.length)];
                    const fullPrompt = `${randomHook} ${context}`;

                    const [audioUrl, generatedClips] = await Promise.all([
                        generateAndPlaySpeech(fullPrompt, apiKey),
                        generateClips(fullPrompt, apiKey)
                    ]);
                    
                    clipsData = generatedClips;
                    displayClipsInEditor(clipsData, apiKey);
                    playSequence(clipsData);

                    if (audioUrl) {
                        const audio = new Audio(audioUrl);
                        audio.play();
                    }


                } catch (error) {
                    console.error("Error generating video:", error);
                    showError("Failed to generate video. Check the console for details.");
                } finally {
                    showLoader(false);
                }
            });
            
            // --- Audio Generation and Processing ---

            function base64ToArrayBuffer(base64) {
                const binaryString = window.atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            }

            function pcmToWav(pcmData, sampleRate) {
                const numChannels = 1;
                const bitsPerSample = 16;
                const blockAlign = numChannels * bitsPerSample / 8;
                const byteRate = sampleRate * blockAlign;
                const dataSize = pcmData.length * pcmData.BYTES_PER_ELEMENT;
                const buffer = new ArrayBuffer(44 + dataSize);
                const view = new DataView(buffer);
                writeString(view, 0, 'RIFF');
                view.setUint32(4, 36 + dataSize, true);
                writeString(view, 8, 'WAVE');
                writeString(view, 12, 'fmt ');
                view.setUint32(16, 16, true);
                view.setUint16(20, 1, true);
                view.setUint16(22, numChannels, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, byteRate, true);
                view.setUint16(32, blockAlign, true);
                view.setUint16(34, bitsPerSample, true);
                writeString(view, 36, 'data');
                view.setUint32(40, dataSize, true);
                new Int16Array(buffer, 44).set(pcmData);
                return new Blob([view], { type: 'audio/wav' });
            }

            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }
            
            async function generateAndPlaySpeech(text, apiKey) {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                const selectedVoice = voiceSelect.value;
                const payload = {
                    "contents": [{"parts":[{"text": `Say cheerfully: ${text}`}]}],
                    "generationConfig": {
                        "responseModalities": ["AUDIO"],
                        "speechConfig": { "voiceConfig": { "prebuiltVoiceConfig": { "voiceName": selectedVoice } } }
                    },
                    "model": "gemini-2.5-flash-preview-tts",
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`TTS API request failed with status ${response.status}`);
                    const result = await response.json();
                    const audioData = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    if (!audioData) throw new Error('No audio data in TTS response.');
                    const pcmBuffer = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmBuffer);
                    const wavBlob = pcmToWav(pcm16, 24000);
                    return URL.createObjectURL(wavBlob);
                } catch (error) {
                    console.error('Failed to generate speech:', error);
                    showError('Could not generate audio for the video.');
                    return null;
                }
            }

            // --- Image and Video Generation ---
            
            async function generateImageFromApi(prompt, apiKey) {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-preview-06-06:predict?key=${apiKey}`;
                const payload = {
                    "instances": [{ "prompt": prompt }],
                    "parameters": { "sampleCount": 1 }
                };
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorBody = await response.json();
                        console.error('Image generation API error:', errorBody);
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                    const result = await response.json();
                    if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                        return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    } else {
                        throw new Error('Invalid response from image generation API');
                    }
                } catch (error) {
                    console.error('Failed to generate image:', error);
                    return `https://placehold.co/400x225/ff0000/FFFFFF?text=Image+API+Error`;
                }
            }

            async function generateVideoFromApi(prompt, apiKey) {
                // =========================================================================================
                // WARNING: THIS IMPLEMENTATION WILL FAIL IN A WEB BROWSER DUE TO CORS RESTRICTIONS.
                // This code demonstrates the required polling logic for the Veo API, but it can only
                // be successfully executed from a server-side environment (like Node.js), not client-side JS.
                // =========================================================================================
                const BASE_URL = "https://generativelanguage.googleapis.com/v1beta";
                const startUrl = `${BASE_URL}/models/veo-3.0-generate-preview:predictLongRunning?key=${apiKey}`;
                const startPayload = { "instances": [{ "prompt": prompt }] };

                try {
                    // 1. Start the video generation job
                    console.log("Starting Veo video generation job...");
                    const initialResponse = await fetch(startUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(startPayload)
                    });

                    if (!initialResponse.ok) throw new Error(`Veo start request failed: ${initialResponse.status}`);
                    
                    const { name: operationName } = await initialResponse.json();
                    console.log(`Veo job started. Operation Name: ${operationName}`);

                    const statusUrl = `${BASE_URL}/${operationName}?key=${apiKey}`;

                    // 2. Poll for the result
                    while (true) {
                        console.log("Polling for Veo video status...");
                        await new Promise(resolve => setTimeout(resolve, 10000)); // Wait 10 seconds

                        const statusResponse = await fetch(statusUrl);
                        if (!statusResponse.ok) throw new Error(`Veo polling failed: ${statusResponse.status}`);
                        
                        const statusResult = await statusResponse.json();

                        if (statusResult.done) {
                            console.log("Veo job finished!");
                            const videoUri = statusResult.response.generateVideoResponse.generatedSamples[0].video.uri;
                            // In a real server app, you'd download from this URI. Here we just return it.
                            // The URI itself is often a signed URL that also requires auth to access.
                            return videoUri; 
                        }
                    }
                } catch (error) {
                    console.error('VEO API LOGIC FAILED (Likely due to CORS):', error);
                    // Return a placeholder on failure
                    const randomColor = Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                    return `https://placehold.co/400x225/${randomColor}/FFFFFF?text=Video+API+Failed`;
                }
            }

            async function generateClips(prompt, apiKey) {
                const artStyle = artStyleSelect.value;
                const clipPromises = [];
                const totalClips = 12;

                for (let i = 0; i < totalClips; i++) {
                    const isVideo = i % 2 === 0;
                    const clipType = isVideo ? 'video' : 'image';
                    const clipPrompt = `Clip ${i + 1}: ${prompt}, style: ${artStyle}`;

                    if (isVideo) {
                        clipPromises.push(generateVideoFromApi(clipPrompt, apiKey).then(content => ({ type: clipType, prompt: clipPrompt, content })));
                    } else {
                        clipPromises.push(generateImageFromApi(clipPrompt, apiKey).then(content => ({ type: clipType, prompt: clipPrompt, content })));
                    }
                }
                
                return Promise.all(clipPromises);
            }
            
            // --- UI and Playback Logic ---

            async function regenerateClip(clipElement, clipData, apiKey, index) {
                const regenLoader = document.createElement('div');
                regenLoader.className = 'loader';
                clipElement.innerHTML = '';
                clipElement.appendChild(regenLoader);

                try {
                    const artStyle = artStyleSelect.value;
                    const newPrompt = `${clipData.prompt.split(', style:')[0]}, style: ${artStyle}`;
                    let newContentUrl;

                    if (clipData.type === 'video') {
                        newContentUrl = await generateVideoFromApi(newPrompt, apiKey);
                    } else {
                        newContentUrl = await generateImageFromApi(newPrompt, apiKey);
                    }

                    const newClipData = {
                        type: clipData.type,
                        prompt: newPrompt,
                        content: newContentUrl
                    };
                    
                    clipsData[index] = newClipData;
                    updateClipElement(clipElement, newClipData, apiKey, index);
                    playSequence(clipsData);

                } catch (error) {
                    console.error("Error regenerating clip:", error);
                    clipElement.innerHTML = '<p class="text-red-500 text-xs">Failed</p>';
                }
            }

            function displayClipsInEditor(clips, apiKey) {
                clipEditor.innerHTML = '';
                clips.forEach((clip, index) => {
                    const clipContainer = document.createElement('div');
                    clipContainer.className = 'relative group';
                    updateClipElement(clipContainer, clip, apiKey, index);
                    clipEditor.appendChild(clipContainer);
                });
            }

            function updateClipElement(element, clipData, apiKey, index) {
                element.innerHTML = '';
                const mediaElement = document.createElement('img');
                mediaElement.src = clipData.content;
                mediaElement.className = 'w-full h-auto object-cover rounded-lg shadow-md';
                
                const overlay = document.createElement('div');
                overlay.className = 'clip-overlay';
                
                const promptText = document.createElement('p');
                promptText.className = 'mb-2';
                promptText.textContent = `Prompt: ${clipData.prompt}`;
                
                const regenerateButton = document.createElement('button');
                regenerateButton.className = 'w-full bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 rounded';
                regenerateButton.textContent = 'Regenerate';
                regenerateButton.onclick = () => regenerateClip(element, clipData, apiKey, index);

                overlay.appendChild(promptText);
                overlay.appendChild(regenerateButton);
                
                element.appendChild(mediaElement);
                element.appendChild(overlay);
            }

            function playSequence(clips) {
                let currentClipIndex = 0;
                let timeoutId;
                const videoClipDuration = 7000;
                const imageClipDuration = 3000;

                function playNextClip() {
                    if (currentClipIndex >= clips.length) {
                        videoPlayer.innerHTML = '<p class="text-white">Video finished.</p>';
                        return;
                    }

                    const clip = clips[currentClipIndex];
                    videoPlayer.innerHTML = '';
                    const img = document.createElement('img');
                    img.src = clip.content;
                    img.className = 'w-full h-full object-cover';
                    videoPlayer.appendChild(img);
                    
                    const duration = clip.type === 'video' ? videoClipDuration : imageClipDuration;
                    timeoutId = setTimeout(playNextClip, duration);
                    currentClipIndex++;
                }
                
                if(timeoutId) clearTimeout(timeoutId);
                playNextClip();
            }

            function showLoader(show) {
                loader.style.display = show ? 'block' : 'none';
            }

            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
            }

            function clearError() {
                errorMessage.style.display = 'none';
            }
        });
    </script>
</body>
</html>
